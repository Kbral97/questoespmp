{% extends "base.html" %}
{% block head %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}
{% block content %}
<div class="mdc-layout-grid">
  <div class="mdc-layout-grid__inner">
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
      <a href="{{ url_for('main.index') }}" class="mdc-button mdc-button--outlined" style="margin-bottom: 16px;">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">Voltar ao Menu</span>
      </a>
      <div class="mdc-card">
        <div class="mdc-card__primary">
          <h2 class="mdc-typography--headline5">Responder Questões</h2>
        </div>
        <div class="mdc-card__content">
          <div id="question-area">
            <div id="question-text" class="mdc-typography--body1" style="margin-bottom: 24px;"></div>
            <div id="options-area"></div>
            <div id="feedback-area" style="margin-top:24px;"></div>
            <div id="actions-area" style="margin-top:24px;display:flex;gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentQuestion = null;
let answered = false;

async function loadQuestion() {
  answered = false;
  document.getElementById('feedback-area').innerHTML = '';
  document.getElementById('actions-area').innerHTML = '';
  
  try {
    // Primeiro, verificar o status do banco
    const statusResp = await fetch('/api/database-status');
    const statusData = await statusResp.json();
    console.log('Status do banco:', statusData);
    
    if (statusData.questions_count === 0) {
      document.getElementById('question-text').innerHTML = `
        <div style="color: #d32f2f; margin-bottom: 16px;">
          <b>Nenhuma questão disponível</b>
        </div>
        <div style="font-size: 0.9em; color: #666;">
          <p>Detalhes do banco de dados:</p>
          <ul>
            <li>Banco existe: ${statusData.database_exists ? 'Sim' : 'Não'}</li>
            <li>Tamanho do banco: ${(statusData.database_size / 1024).toFixed(2)} KB</li>
            <li>Tabelas: ${statusData.tables.join(', ')}</li>
          </ul>
          <p>Por favor, gere algumas questões antes de tentar respondê-las.</p>
        </div>
      `;
      document.getElementById('options-area').innerHTML = '';
      return;
    }
    
    const resp = await fetch('/api/random-question');
    const data = await resp.json();
    
    if (!resp.ok) {
      console.error('Erro ao carregar questão:', data);
      document.getElementById('question-text').textContent = data.error || 'Erro ao carregar questão.';
      if (data.details) {
        document.getElementById('question-text').textContent += ` ${data.details}`;
      }
      document.getElementById('options-area').innerHTML = '';
      return;
    }
    
    console.log('Questão carregada:', data); // Log para debug
    
    // Validar campos obrigatórios
    const requiredFields = ['id', 'question', 'options', 'correct_answer', 'explanation', 'topic'];
    const missingFields = requiredFields.filter(field => !data[field]);
    
    if (missingFields.length > 0) {
      console.error('Campos obrigatórios ausentes:', missingFields);
      document.getElementById('question-text').textContent = 'Erro: Questão incompleta. Campos obrigatórios ausentes.';
      document.getElementById('options-area').innerHTML = '';
      return;
    }
    
    currentQuestion = data;
    document.getElementById('question-text').textContent = data.question;
    
    const optionsArea = document.getElementById('options-area');
    optionsArea.innerHTML = '';
    
    if (!Array.isArray(data.options) || data.options.length === 0) {
      console.error('Opções inválidas:', data.options);
      document.getElementById('question-text').textContent = 'Erro: Opções inválidas.';
      return;
    }
    
    // Classificar o tamanho do texto das opções
    const textLengths = data.options.map(opt => opt.length);
    const avgLength = textLengths.reduce((a, b) => a + b, 0) / textLengths.length;
    
    data.options.forEach((opt, idx) => {
      const div = document.createElement('div');
      div.className = 'option';
      // Determinar o tamanho do texto
      let textLength = 'medium';
      if (opt.length > avgLength * 1.5) {
        textLength = 'long';
      } else if (opt.length < avgLength * 0.7) {
        textLength = 'short';
      }
      div.setAttribute('data-text-length', textLength);
      div.innerHTML = `<span class="option-label">${String.fromCharCode(65+idx)}. ${opt}</span>`;
      div.onclick = () => answerQuestion(idx, div);
      div.style.cursor = 'pointer';
      optionsArea.appendChild(div);
    });
    
  } catch (error) {
    console.error('Erro ao carregar questão:', error);
    document.getElementById('question-text').textContent = 'Erro ao carregar questão. Por favor, tente novamente.';
    document.getElementById('options-area').innerHTML = '';
  }
}

async function answerQuestion(idx, div) {
  if (answered) return;
  answered = true;
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const resp = await fetch('/api/answer-question', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ question_id: currentQuestion.id, selected_index: idx })
  });
  const data = await resp.json();
  const optionsArea = document.getElementById('options-area');
  const divs = optionsArea.querySelectorAll('.option');
  // Log para debug
  console.log('Resposta:', {
    selected: idx,
    correct: data.correct_index,
    isCorrect: data.correct
  });
  divs.forEach((d, i) => {
    d.onclick = null;
    d.classList.remove('selected', 'correct', 'incorrect');
    if (i === data.correct_index) {
      d.classList.add('correct');
      d.innerHTML = `<span class="option-label">${String.fromCharCode(65+i)}. ${currentQuestion.options[i]} ✓</span>`;
    } else if (i === idx) {
      d.classList.add('incorrect');
      d.innerHTML = `<span class="option-label">${String.fromCharCode(65+i)}. ${currentQuestion.options[i]} ✗</span>`;
    }
  });
  let feedback = '';
  const feedbackArea = document.getElementById('feedback-area');
  if (data.correct) {
    feedback = `<span class='feedback-icon'>✓</span> <span class='feedback-title'>Correto!</span><br><span>${data.explanation || ''}</span>`;
    feedbackArea.className = 'feedback-correct';
  } else {
    const correctIdx = data.correct_index !== undefined ? data.correct_index : data.correct_answer;
    const letra = String.fromCharCode(65 + correctIdx);
    const textoCorreta = currentQuestion.options[correctIdx];
    feedback = `<span class='feedback-icon'>✗</span> <span class='feedback-title'>Incorreto.</span>`;
    feedback += `<br><b>Resposta correta:</b> <span style='color:#388e3c;'>${letra}. ${textoCorreta}</span>`;
    feedback += `<br><b>Justificativa:</b> <span>${data.explanation || ''}</span>`;
    feedbackArea.className = 'feedback-incorrect';
  }
  feedbackArea.innerHTML = feedback;
  renderActions();
}

function renderActions() {
  const actions = document.getElementById('actions-area');
  actions.innerHTML = '';
  // Próxima questão
  const nextBtn = document.createElement('button');
  nextBtn.className = 'mdc-button mdc-button--raised';
  nextBtn.innerHTML = '<span class="mdc-button__ripple"></span><span class="mdc-button__label">Próxima Questão</span>';
  nextBtn.onclick = loadQuestion;
  actions.appendChild(nextBtn);
  // Reportar problema
  const reportBtn = document.createElement('button');
  reportBtn.className = 'mdc-button mdc-button--outlined';
  reportBtn.innerHTML = '<span class="mdc-button__ripple"></span><span class="mdc-button__label">Reportar Problema</span>';
  reportBtn.onclick = showReportDialog;
  actions.appendChild(reportBtn);
}

function showReportDialog() {
  const area = document.getElementById('feedback-area');
  let html = `<div id='report-dialog' style='background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 8px #0002;max-width:400px;margin:0 auto;'>`;
  html += `<div style='margin-bottom:8px;'><b>Reportar problema nesta questão:</b></div>`;
  html += `<select id='problem-type' class='mdc-text-field__input' style='width:100%;margin-bottom:8px;'>
    <option value='muito_facil'>Questão muito fácil</option>
    <option value='opcoes_obvias'>Opções óbvias</option>
    <option value='questao_confusa'>Questão confusa</option>
    <option value='problema_explicacao'>Problema na explicação</option>
    <option value='outro'>Outro</option>
  </select>`;
  html += `<textarea id='problem-details' class='mdc-text-field__input' style='width:100%;height:60px;margin-bottom:8px;' placeholder='Descreva o problema (opcional)'></textarea>`;
  html += `<button class='mdc-button mdc-button--raised' onclick='submitReport()'><span class="mdc-button__ripple"></span><span class="mdc-button__label">Enviar</span></button> `;
  html += `<button class='mdc-button mdc-button--outlined' onclick='closeReportDialog()'><span class="mdc-button__ripple"></span><span class="mdc-button__label">Cancelar</span></button>`;
  html += `</div>`;
  area.innerHTML = html;
}

async function submitReport() {
  const type = document.getElementById('problem-type').value;
  const details = document.getElementById('problem-details').value;
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const resp = await fetch('/api/report-question', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ question_id: currentQuestion.id, problem_type: type, details })
  });
  if (resp.ok) {
    document.getElementById('feedback-area').innerHTML = '<b>Obrigado pelo feedback! A questão foi removida.</b>';
    document.getElementById('actions-area').innerHTML = '';
    setTimeout(loadQuestion, 1500);
  } else {
    document.getElementById('feedback-area').innerHTML = '<b>Erro ao reportar problema.</b>';
  }
}
function closeReportDialog() {
  document.getElementById('feedback-area').innerHTML = '';
  renderActions();
}

window.addEventListener('DOMContentLoaded', loadQuestion);
</script>
{% endblock %}

<style>
.option {
    padding: 24px 18px;
    margin-bottom: 32px;
    border: 2px solid #bbb;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    line-height: 1.7;
    font-size: 17px;
    min-height: 70px;
    display: flex;
    align-items: center;
    position: relative;
}
.option:not(:last-child) {
    border-bottom: 4px solid #e0e0e0;
}
.option:nth-child(even) {
    background-color: #f7fafd;
}
.option.selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
}
.option.correct {
    background-color: #e8f5e9;
    border-color: #4caf50;
}
.option.incorrect {
    background-color: #ffebee;
    border-color: #f44336;
}
.option[data-text-length="long"] {
    padding: 28px 18px;
    line-height: 1.85;
}
.option[data-text-length="medium"] {
    padding: 24px 18px;
    line-height: 1.75;
}
.option[data-text-length="short"] {
    padding: 22px 18px;
    line-height: 1.7;
}
@media (max-width: 768px) {
    .option {
        padding: 14px 8px;
        margin-bottom: 18px;
        font-size: 15px;
    }
    .option[data-text-length="long"] {
        padding: 18px 8px;
    }
    .option[data-text-length="medium"] {
        padding: 16px 8px;
    }
}
#feedback-area {
    margin-top: 24px;
    padding: 24px 18px;
    border-radius: 10px;
    font-size: 1.15em;
    font-weight: 500;
    min-height: 48px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    transition: background 0.3s, color 0.3s;
}
.feedback-correct {
    background: #e8f5e9;
    color: #256029;
    border: 2.5px solid #43a047;
    box-shadow: 0 2px 16px #43a04722;
}
.feedback-incorrect {
    background: #ffebee;
    color: #b71c1c;
    border: 2.5px solid #e53935;
    box-shadow: 0 2px 16px #e5393522;
}
.feedback-icon {
    font-size: 2.2em;
    font-weight: bold;
    vertical-align: middle;
    margin-right: 10px;
}
.feedback-title {
    font-size: 1.2em;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 6px;
}
</style> 