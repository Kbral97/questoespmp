{% extends "base.html" %}

{% block content %}
<div class="mdc-layout-grid">
    <div class="mdc-layout-grid__inner">
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
            <div class="mdc-card">
                <div class="mdc-card__primary">
                    <h2 class="mdc-typography--headline5">Gerar Questões</h2>
                    <p class="mdc-typography--body1" style="margin-top: 8px; color: rgba(0, 0, 0, 0.6);">
                        Configure os parâmetros abaixo para gerar questões personalizadas do PMP.
                    </p>
                </div>
                <div class="mdc-card__content">
                    <form id="generateForm" class="mdc-form">
                        <div class="mdc-layout-grid__inner">
                            <!-- Seção: Tópico -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                                <h3 class="mdc-typography--subtitle1" style="margin-bottom: 16px; color: rgba(0, 0, 0, 0.87);">
                                    1. Selecione o Tópico Principal
                                </h3>
                                <div class="mdc-select mdc-select--outlined" style="width: 100%;">
                                    <div class="mdc-select__anchor" style="width: 100%;">
                                        <span class="mdc-notched-outline">
                                            <span class="mdc-notched-outline__leading"></span>
                                            <span class="mdc-notched-outline__notch">
                                                <span class="mdc-floating-label">Tópico do PMBOK</span>
                                            </span>
                                            <span class="mdc-notched-outline__trailing"></span>
                                        </span>
                                        <span class="mdc-select__selected-text-container">
                                            <span class="mdc-select__selected-text"></span>
                                        </span>
                                        <span class="mdc-select__dropdown-icon">
                                            <svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5">
                                                <polygon class="mdc-select__dropdown-icon-inactive" stroke="none" fill-rule="evenodd" points="7 10 12 15 17 10"></polygon>
                                                <polygon class="mdc-select__dropdown-icon-active" stroke="none" fill-rule="evenodd" points="7 15 12 10 17 15"></polygon>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                        <ul class="mdc-list" role="listbox">
                                            <li class="mdc-list-item" data-value="Gerenciamento da Integração">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento da Integração</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento do Escopo">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento do Escopo</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento do Cronograma">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento do Cronograma</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento dos Custos">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento dos Custos</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento da Qualidade">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento da Qualidade</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento dos Recursos">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento dos Recursos</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento das Comunicações">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento das Comunicações</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento dos Riscos">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento dos Riscos</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento das Aquisições">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento das Aquisições</span>
                                            </li>
                                            <li class="mdc-list-item" data-value="Gerenciamento das Partes Interessadas">
                                                <span class="mdc-list-item__ripple"></span>
                                                <span class="mdc-list-item__text">Gerenciamento das Partes Interessadas</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Seção: Configurações de Geração -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                                <h3 class="mdc-typography--subtitle1" style="margin: 24px 0 16px; color: rgba(0, 0, 0, 0.87);">
                                    2. Configure a Geração
                                </h3>
                            </div>

                            <!-- Número de Questões -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6">
                                <div class="config-field-container">
                                    <label class="mdc-typography--body2" style="display: block; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                                        Número de Questões
                                        <span class="mdc-typography--caption" style="display: block; margin-top: 4px;">
                                            Quantidade total de questões a serem geradas
                                        </span>
                                    </label>
                                    <div class="mdc-text-field mdc-text-field--outlined" style="width: 100%;">
                                        <input type="number" class="mdc-text-field__input" id="numQuestions" min="1" max="10" value="1" required>
                                        <div class="mdc-notched-outline">
                                            <div class="mdc-notched-outline__leading"></div>
                                            <div class="mdc-notched-outline__notch">
                                                <label for="numQuestions" class="mdc-floating-label">Questões (1-10)</label>
                                            </div>
                                            <div class="mdc-notched-outline__trailing"></div>
                                        </div>
                                    </div>
                                    <div class="mdc-text-field-helper-line">
                                        <div class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent">
                                            Digite um número entre 1 e 10
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Número de Sub-temas -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6">
                                <div class="config-field-container">
                                    <label class="mdc-typography--body2" style="display: block; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                                        Número de Sub-temas
                                        <span class="mdc-typography--caption" style="display: block; margin-top: 4px;">
                                            Em quantos sub-temas as questões serão divididas
                                        </span>
                                    </label>
                                    <div class="mdc-text-field mdc-text-field--outlined" style="width: 100%;">
                                        <input type="number" class="mdc-text-field__input" id="numSubtopics" min="1" max="5" value="1" required>
                                        <div class="mdc-notched-outline">
                                            <div class="mdc-notched-outline__leading"></div>
                                            <div class="mdc-notched-outline__notch">
                                                <label for="numSubtopics" class="mdc-floating-label">Sub-temas (1-5)</label>
                                            </div>
                                            <div class="mdc-notched-outline__trailing"></div>
                                        </div>
                                    </div>
                                    <div class="mdc-text-field-helper-line">
                                        <div class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent">
                                            Digite um número entre 1 e 5
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botão de Gerar -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12" style="margin-top: 24px;">
                                <button type="submit" class="mdc-button mdc-button--raised" style="width: 100%;">
                                    <span class="mdc-button__ripple"></span>
                                    <i class="material-icons mdc-button__icon" aria-hidden="true">auto_awesome</i>
                                    <span class="mdc-button__label">Gerar Questões</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12" id="resultsSection" style="display: none;">
            <div class="mdc-card">
                <div class="mdc-card__primary">
                    <h2 class="mdc-typography--headline5">Questões Geradas</h2>
                </div>
                <div class="mdc-card__content">
                    <div id="generatedQuestions"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Dialog -->
<div class="mdc-dialog" id="progressDialog">
    <div class="mdc-dialog__container">
        <div class="mdc-dialog__surface">
            <h2 class="mdc-dialog__title">Gerando Questões</h2>
            <div class="mdc-dialog__content">
                <div class="mdc-linear-progress mdc-linear-progress--indeterminate">
                    <div class="mdc-linear-progress__buffer">
                        <div class="mdc-linear-progress__buffer-bar"></div>
                        <div class="mdc-linear-progress__buffer-dots"></div>
                    </div>
                    <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                        <span class="mdc-linear-progress__bar-inner"></span>
                    </div>
                    <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                        <span class="mdc-linear-progress__bar-inner"></span>
                    </div>
                </div>
                <p id="progressMessage">Preparando para gerar questões...</p>
            </div>
        </div>
    </div>
    <div class="mdc-dialog__scrim"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando componentes...');
    
    // Inicializar componentes MDC
    const textFields = document.querySelectorAll('.mdc-text-field');
    textFields.forEach(textField => mdc.textField.MDCTextField.attachTo(textField));

    // Inicializar select com referência global
    const topicSelect = document.querySelector('.mdc-select');
    console.log('Elemento select encontrado:', topicSelect);
    
    window.mdcTopicSelect = mdc.select.MDCSelect.attachTo(topicSelect);
    console.log('Select MDC inicializado');
    
    window.mdcTopicSelect.listen('MDCSelect:change', () => {
        console.log('Select alterado. Novo valor:', window.mdcTopicSelect.value);
    });

    // Manipular envio do formulário
    const form = document.getElementById('generateForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Verificar se o select está inicializado
        if (!window.mdcTopicSelect) {
            console.error('Select não inicializado');
            alert('Erro: Componente de seleção não inicializado corretamente. Por favor, recarregue a página.');
            return;
        }
        
        const topic = window.mdcTopicSelect.value;
        console.log('Tópico no envio:', topic);

        const numQuestions = document.getElementById('numQuestions').value;
        const numSubtopics = document.getElementById('numSubtopics').value;

        // Validar campos antes de enviar
        if (!topic) {
            console.log('Tópico não selecionado ou valor inválido');
            alert('Por favor, selecione um tópico.');
            return;
        }

        if (!numQuestions || numQuestions < 1 || numQuestions > 10) {
            alert('O número de questões deve estar entre 1 e 10.');
            return;
        }

        if (!numSubtopics || numSubtopics < 1 || numSubtopics > 5) {
            alert('O número de sub-temas deve estar entre 1 e 5.');
            return;
        }
        
        // Mostrar diálogo de progresso
        const progressDialog = new mdc.dialog.MDCDialog(document.getElementById('progressDialog'));
        progressDialog.open();
        
        // Enviar requisição para gerar questões
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (!csrfMeta) {
            alert('Erro interno: CSRF token não encontrado no template.');
            progressDialog.close();
            return;
        }
        const csrfToken = csrfMeta.getAttribute('content');
        fetch('/api/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                topic: topic,
                num_questions: parseInt(numQuestions),
                num_subtopics: parseInt(numSubtopics)
            })
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    // Redirecionar para a página de login
                    window.location.href = '/login';
                    throw new Error('Sessão expirada. Por favor, faça login novamente.');
                }
                return response.json().then(data => {
                    throw new Error(data.error || 'Erro ao gerar questões');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Mostrar questões geradas
            const questionsContainer = document.getElementById('generatedQuestions');
            questionsContainer.innerHTML = '';
            
            data.questions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'mdc-card question-card';
                questionCard.style.marginBottom = '1rem';
                questionCard.style.padding = '1rem';
                
                const questionContent = `
                    <div class="question-header">
                        <h3 class="mdc-typography--headline6">Questão ${index + 1}</h3>
                        <div class="mdc-chip-set">
                            <div class="mdc-chip">
                                <div class="mdc-chip__text">Tópico: ${question.topic}</div>
                            </div>
                            <div class="mdc-chip">
                                <div class="mdc-chip__text">Sub-tópico: ${question.subtopic}</div>
                            </div>
                        </div>
                    </div>
                    <div class="question-body">
                        <p class="mdc-typography--body1">${question.question}</p>
                        <div class="mdc-list">
                            ${question.options.map((option, i) => `
                                <div class="mdc-list-item">
                                    <span class="mdc-list-item__ripple"></span>
                                    <span class="mdc-list-item__text">${String.fromCharCode(65 + i)}. ${option}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="question-footer">
                        <div class="mdc-card__actions">
                            <button class="mdc-button mdc-button--outlined show-answer-btn" onclick="toggleAnswer(${index})">
                                <span class="mdc-button__ripple"></span>
                                <span class="mdc-button__label">Mostrar Resposta</span>
                            </button>
                        </div>
                        <div class="answer-section" id="answer-${index}" style="display: none;">
                            <div class="mdc-card__content" style="margin-top: 1rem;">
                                <p class="mdc-typography--subtitle2">Resposta Correta: ${question.correct_answer}</p>
                                <p class="mdc-typography--body2">Explicação: ${question.explanation}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                questionCard.innerHTML = questionContent;
                questionsContainer.appendChild(questionCard);
            });
            
            // Esconder diálogo de progresso e mostrar resultados
            progressDialog.close();
            document.getElementById('resultsSection').style.display = 'block';
            
            // Rolar para os resultados
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            progressDialog.close();
            alert('Erro ao gerar questões: ' + error.message);
        });
    });
});

// Função para alternar a visibilidade da resposta
function toggleAnswer(index) {
    const answerSection = document.getElementById(`answer-${index}`);
    const button = event.currentTarget;
    
    if (answerSection.style.display === 'none') {
        answerSection.style.display = 'block';
        button.querySelector('.mdc-button__label').textContent = 'Ocultar Resposta';
    } else {
        answerSection.style.display = 'none';
        button.querySelector('.mdc-button__label').textContent = 'Mostrar Resposta';
    }
}
</script>

<style>
.question-card {
    border: 1px solid rgba(0, 0, 0, 0.12);
    border-radius: 4px;
}

.question-header {
    margin-bottom: 1rem;
}

.question-body {
    margin-bottom: 1rem;
}

.mdc-chip-set {
    margin-top: 0.5rem;
}

.mdc-chip {
    margin-right: 0.5rem;
}

.answer-section {
    border-top: 1px solid rgba(0, 0, 0, 0.12);
    padding-top: 1rem;
    margin-top: 1rem;
}

.config-field-container {
    background-color: #f5f5f5;
    padding: 16px;
    border-radius: 4px;
    height: 100%;
}

.mdc-text-field {
    background-color: white !important;
}

.mdc-select {
    background-color: white !important;
}

.mdc-button--raised {
    background-color: #6200ee !important;
}

.mdc-typography--subtitle1 {
    font-weight: 500;
}

.mdc-typography--caption {
    color: rgba(0, 0, 0, 0.6);
}
</style>
{% endblock %} 