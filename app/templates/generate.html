{% extends "base.html" %}

{% block head %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        .ai-section {
            margin: 16px 0;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 4px;
        }
        
        .ai-section h5 {
            margin-bottom: 12px;
            color: rgba(0, 0, 0, 0.87);
        }
        
        .ai-section pre {
            background-color: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .question-details {
            margin-top: 16px;
            padding: 16px;
            background-color: #fafafa;
            border-radius: 4px;
        }
        
        .mdc-button--icon {
            min-width: 40px;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
        }
        
        .mdc-button--icon .material-icons {
            font-size: 24px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="mdc-layout-grid">
    <div class="mdc-layout-grid__inner">
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
            <div class="mdc-card">
                <div class="mdc-card__primary">
                    <h2 class="mdc-typography--headline5">Gerar Questões</h2>
                    <p class="mdc-typography--body1" style="margin-top: 8px; color: rgba(0, 0, 0, 0.6);">
                        Configure os parâmetros abaixo para gerar questões personalizadas do PMP.
                    </p>
                </div>
                <div class="mdc-card__content">
                    <a href="{{ url_for('main.index') }}" class="mdc-button mdc-button--outlined" style="margin-bottom: 16px;">
                        <span class="mdc-button__ripple"></span>
                        <span class="mdc-button__label">Voltar ao Menu</span>
                    </a>
                    <form id="generateForm" class="mdc-form">
                        <div class="mdc-layout-grid__inner">
                            <!-- Seção: Tópico -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                                <h3 class="mdc-typography--subtitle1" style="margin-bottom: 16px; color: rgba(0, 0, 0, 0.87);">
                                    1. Selecione o Tópico Principal
                                </h3>
                                <div class="mdc-select mdc-select--outlined" style="width: 100%;">
                                    <div class="mdc-select__anchor" style="width: 100%;">
                                        <span class="mdc-notched-outline">
                                            <span class="mdc-notched-outline__leading"></span>
                                            <span class="mdc-notched-outline__notch">
                                                <span class="mdc-floating-label">Tópico do PMBOK</span>
                                            </span>
                                            <span class="mdc-notched-outline__trailing"></span>
                                        </span>
                                        <span class="mdc-select__selected-text-container">
                                            <span class="mdc-select__selected-text"></span>
                                        </span>
                                        <span class="mdc-select__dropdown-icon">
                                            <svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5">
                                                <polygon class="mdc-select__dropdown-icon-inactive" stroke="none" fill-rule="evenodd" points="7 10 12 15 17 10"></polygon>
                                                <polygon class="mdc-select__dropdown-icon-active" stroke="none" fill-rule="evenodd" points="7 15 12 10 17 15"></polygon>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                        <ul class="mdc-list" role="listbox" id="domainList">
                                            <!-- Domínios serão carregados aqui via JavaScript -->
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Seção: Configurações de Geração -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                                <h3 class="mdc-typography--subtitle1" style="margin: 24px 0 16px; color: rgba(0, 0, 0, 0.87);">
                                    2. Configure a Geração
                                </h3>
                            </div>

                            <!-- Número de Questões -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6">
                                <div class="config-field-container">
                                    <label class="mdc-typography--body2" style="display: block; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                                        Número de Questões
                                        <span class="mdc-typography--caption" style="display: block; margin-top: 4px;">
                                            Quantidade total de questões a serem geradas
                                        </span>
                                    </label>
                                    <div class="mdc-text-field mdc-text-field--outlined" style="width: 100%; margin-bottom: 16px;">
                                        <input type="number" class="mdc-text-field__input" id="numQuestions" min="1" max="20" value="5" required>
                                        <div class="mdc-notched-outline">
                                            <div class="mdc-notched-outline__leading"></div>
                                            <div class="mdc-notched-outline__notch">
                                                <label for="numQuestions" class="mdc-floating-label">Número de Questões (1-20)</label>
                                            </div>
                                            <div class="mdc-notched-outline__trailing"></div>
                                        </div>
                                    </div>
                                    <div class="mdc-text-field-helper-line">
                                        <div class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent">
                                            Digite um número entre 1 e 20
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botão de Gerar -->
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12" style="margin-top: 24px;">
                                <button type="submit" class="mdc-button mdc-button--raised" style="width: 100%;">
                                    <span class="mdc-button__ripple"></span>
                                    <i class="material-icons mdc-button__icon" aria-hidden="true">auto_awesome</i>
                                    <span class="mdc-button__label">Gerar Questões</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12" id="resultsSection" style="display: none;">
            <div class="mdc-card">
                <div class="mdc-card__primary">
                    <h2 class="mdc-typography--headline5">Questões Geradas</h2>
                </div>
                <div class="mdc-card__content">
                    <div id="generatedQuestions"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Dialog -->
<div class="mdc-dialog" id="progressDialog">
    <div class="mdc-dialog__container">
        <div class="mdc-dialog__surface">
            <h2 class="mdc-dialog__title">Gerando Questões</h2>
            <div class="mdc-dialog__content">
                <div class="mdc-linear-progress mdc-linear-progress--indeterminate" id="progressBar">
                    <div class="mdc-linear-progress__buffer">
                        <div class="mdc-linear-progress__buffer-bar"></div>
                        <div class="mdc-linear-progress__buffer-dots"></div>
                    </div>
                    <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                        <span class="mdc-linear-progress__bar-inner"></span>
                    </div>
                    <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                        <span class="mdc-linear-progress__bar-inner"></span>
                    </div>
                </div>
                <p id="progressMessage" class="mdc-typography--body1" style="margin-top: 16px; text-align: center;">Preparando para gerar questões...</p>
                <div id="progressSteps" class="mdc-typography--body2" style="margin-top: 8px;">
                    <div class="progress-step" style="display: flex; align-items: center; margin: 4px 0;">
                        <i class="material-icons" style="margin-right: 8px;">pending</i>
                        <span>Validando parâmetros</span>
                    </div>
                    <div class="progress-step" style="display: flex; align-items: center; margin: 4px 0;">
                        <i class="material-icons" style="margin-right: 8px;">pending</i>
                        <span>Gerando questões</span>
                    </div>
                    <div class="progress-step" style="display: flex; align-items: center; margin: 4px 0;">
                        <i class="material-icons" style="margin-right: 8px;">pending</i>
                        <span>Processando resultados</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mdc-dialog__scrim"></div>
</div>

<div class="mdc-card" style="margin-top: 20px; padding: 20px;">
    <h3>Questões Geradas</h3>
    <div id="questionsContainer"></div>
</div>

<div class="mdc-card" style="margin-top: 20px; padding: 20px;">
    <h3>Informações de Debug</h3>
    <div id="debugContainer"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando componentes...');
    
    // Inicializar componentes MDC
    const textFields = document.querySelectorAll('.mdc-text-field');
    textFields.forEach(textField => mdc.textField.MDCTextField.attachTo(textField));

    // Log para verificar se o MDC Dialog está disponível
    console.log('MDC Dialog disponível:', typeof mdc.dialog !== 'undefined');
    
    // Verificar se o elemento do diálogo existe
    const progressDialogElement = document.getElementById('progressDialog');
    console.log('Elemento do diálogo encontrado:', progressDialogElement !== null);
    
    // Tentar inicializar o diálogo antecipadamente
    try {
        window.progressDialog = new mdc.dialog.MDCDialog(progressDialogElement);
        console.log('Diálogo inicializado com sucesso');
    } catch (error) {
        console.error('Erro ao inicializar diálogo:', error);
    }

    // Inicializar select com referência global
    const topicSelect = document.querySelector('.mdc-select');
    console.log('Elemento select encontrado:', topicSelect);
    
    window.mdcTopicSelect = mdc.select.MDCSelect.attachTo(topicSelect);
    console.log('Select MDC inicializado');
    
    window.mdcTopicSelect.listen('MDCSelect:change', () => {
        console.log('Select alterado. Novo valor:', window.mdcTopicSelect.value);
    });

    // Carregar domínios do banco de dados
    fetch('/api/domains')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const domainList = document.getElementById('domainList');
                data.domains.forEach(domain => {
                    const li = document.createElement('li');
                    li.className = 'mdc-list-item';
                    li.setAttribute('data-value', domain.name);
                    li.setAttribute('role', 'option');
                    li.innerHTML = `
                        <span class="mdc-list-item__ripple"></span>
                        <span class="mdc-list-item__text">${domain.name}</span>
                    `;
                    domainList.appendChild(li);
                });
                
                // Inicializar o select APÓS adicionar os itens
                const select = new mdc.select.MDCSelect(document.querySelector('.mdc-select'));
                select.listen('MDCSelect:change', () => {
                    console.log(`Selected domain: ${select.value}`);
                });
                
                // Armazenar a referência do select globalmente
                window.mdcTopicSelect = select;
            } else {
                console.error('Erro ao carregar domínios:', data.error);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar domínios:', error);
        });

    // Manipular envio do formulário
    const form = document.getElementById('generateForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Verificar se o select está inicializado
        if (!window.mdcTopicSelect) {
            console.error('Select não inicializado');
            alert('Erro: Componente de seleção não inicializado corretamente. Por favor, recarregue a página.');
            return;
        }
        
        const topic = window.mdcTopicSelect.value;
        console.log('Tópico no envio:', topic);

        const numQuestions = document.getElementById('numQuestions').value;

        // Validar campos antes de enviar
        if (!topic) {
            console.log('Tópico não selecionado ou valor inválido');
            alert('Por favor, selecione um tópico.');
            return;
        }

        if (!numQuestions || numQuestions < 1 || numQuestions > 20) {
            alert('O número de questões deve estar entre 1 e 20.');
            return;
        }
        
        // Verificar se o diálogo está disponível
        if (!window.progressDialog) {
            console.error('Diálogo não inicializado');
            try {
                window.progressDialog = new mdc.dialog.MDCDialog(document.getElementById('progressDialog'));
                console.log('Diálogo inicializado no submit');
            } catch (error) {
                console.error('Erro ao inicializar diálogo no submit:', error);
                alert('Erro interno: não foi possível mostrar o diálogo de progresso');
                return;
            }
        }
        
        try {
            window.progressDialog.open();
            updateProgress(0, 'Validando parâmetros...');
            console.log('Diálogo aberto com sucesso');
        } catch (error) {
            console.error('Erro ao abrir diálogo:', error);
            alert('Erro interno: não foi possível mostrar o diálogo de progresso');
            return;
        }
        
        // Enviar requisição para gerar questões
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (!csrfMeta) {
            alert('Erro interno: CSRF token não encontrado no template.');
            safeCloseDialog();
            return;
        }
        
        updateProgress(1, 'Gerando questões...');
        
        const csrfToken = csrfMeta.getAttribute('content');
        fetch('/api/generate-questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                topic: topic,
                num_questions: parseInt(numQuestions)
            })
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    throw new Error('Sessão expirada. Por favor, faça login novamente.');
                }
                return response.json().then(data => {
                    throw new Error(data.error || 'Erro ao gerar questões');
                });
            }
            updateProgress(2, 'Processando resultados...');
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Armazenar as questões geradas globalmente
            window.generatedQuestions = data.questions;
            
            // Mostrar questões geradas
            const questionsContainer = document.getElementById('generatedQuestions');
            questionsContainer.innerHTML = '';
            
            data.questions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'mdc-card question-card';
                questionCard.style.marginBottom = '1rem';
                questionCard.style.padding = '1rem';
                
                const questionContent = createQuestionHTML(question, index);
                questionCard.innerHTML = questionContent;
                questionsContainer.appendChild(questionCard);
            });
            
            safeCloseDialog();
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            safeCloseDialog();
            alert('Erro ao gerar questões: ' + error.message);
        });
    });
});

// Função para montar o HTML da questão
function createQuestionHTML(question, index) {
    const hasGenerationDetails = question.question_prompt_id && 
        question.answer_prompt_id && 
        question.distractors_prompt_id;
    
    const hasDistractorIssues = question.metadata && question.metadata.warnings && question.metadata.warnings.length > 0;

    return `
        <div class="question-card mdc-card" style="margin-bottom: 1rem; padding: 1rem;" id="question-${index}">
            <div class="question-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h3 class="mdc-typography--headline6" style="margin-right: 16px;">Questão ${index + 1}</h3>
                        ${hasDistractorIssues ? `
                            <div class="mdc-chip warning-chip" title="Problemas com distratores">
                                <i class="material-icons" style="color: #ff9800; margin-right: 4px;">warning</i>
                                <span class="mdc-chip__text">Problemas com distratores</span>
                            </div>
                        ` : ''}
                    </div>
                    <div>
                        <button class="mdc-button mdc-button--icon" onclick="toggleAnswer(${index})">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon">visibility</i>
                        </button>
                        <button class="mdc-button mdc-button--icon" onclick="toggleQuestionDetails(${index})">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon">add</i>
                        </button>
                        <button class="mdc-button mdc-button--icon" onclick="deleteQuestion(${index})" title="Excluir questão">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon" style="color: #dc3545;">delete</i>
                        </button>
                    </div>
                </div>
                <div class="mdc-chip-set">
                    <div class="mdc-chip">
                        <div class="mdc-chip__text">Tópico: ${question.topic}</div>
                    </div>
                </div>
                ${hasDistractorIssues ? `
                    <div class="distractor-issues" style="margin-top: 8px; padding: 8px; background-color: #fff3e0; border-radius: 4px;">
                        <p class="mdc-typography--body2" style="color: #e65100; margin: 0;">
                            <i class="material-icons" style="font-size: 16px; vertical-align: text-bottom;">info</i>
                            Problemas encontrados:
                        </p>
                        <ul style="margin: 4px 0 0 0; padding-left: 24px;">
                            ${question.metadata.warnings.map(warning => `
                                <li class="mdc-typography--body2" style="color: #e65100;">${warning}</li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
            <div class="question-body">
                <p class="mdc-typography--body1">${question.question}</p>
                <div class="mdc-list">
                    ${question.options.map((opt, idx) => `
                        <div class="mdc-list-item">
                            <span class="mdc-list-item__ripple"></span>
                            <span class="mdc-list-item__text">${String.fromCharCode(65 + idx)}. ${opt}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="answer-section" id="answerSection${index}" style="display: none;">
                <h4 class="mdc-typography--subtitle1">Resposta e Justificativa</h4>
                <div class="mdc-typography--body1">
                    <p><strong>Resposta Correta:</strong> ${String.fromCharCode(65 + question.correct_answer)}</p>
                    <p><strong>Justificativa:</strong> ${question.explanation}</p>
                </div>
            </div>
            <div class="question-details" id="questionDetails${index}" style="display: none;">
                <div class="mdc-card" style="margin-top: 16px;">
                    <div class="mdc-card__content">
                        <h4 class="mdc-typography--subtitle1">Detalhes da Geração</h4>
                        ${hasGenerationDetails ? `
                            <!-- IA de Geração de Pergunta -->
                            <div class="ai-section">
                                <h5 class="mdc-typography--subtitle2">IA de Geração de Pergunta</h5>
                                <div class="mdc-typography--body2">
                                    <strong>Prompt:</strong>
                                    <pre id="questionPrompt${index}">Carregando...</pre>
                                    <strong>Chunks Utilizados:</strong>
                                    <pre id="questionChunks${index}">Carregando...</pre>
                                </div>
                            </div>
                            
                            <!-- IA de Geração de Resposta -->
                            <div class="ai-section">
                                <h5 class="mdc-typography--subtitle2">IA de Geração de Resposta</h5>
                                <div class="mdc-typography--body2">
                                    <strong>Prompt:</strong>
                                    <pre id="answerPrompt${index}">Carregando...</pre>
                                    <strong>Chunks Utilizados:</strong>
                                    <pre id="answerChunks${index}">Carregando...</pre>
                                </div>
                            </div>
                            
                            <!-- IA de Geração de Distratores -->
                            <div class="ai-section">
                                <h5 class="mdc-typography--subtitle2">IA de Geração de Distratores</h5>
                                <div class="mdc-typography--body2">
                                    <strong>Prompt:</strong>
                                    <pre id="distractorsPrompt${index}">Carregando...</pre>
                                    <strong>Chunks Utilizados:</strong>
                                    <pre id="distractorsChunks${index}">Carregando...</pre>
                                </div>
                            </div>
                        ` : `
                            <p class="mdc-typography--body1">Detalhes de geração não disponíveis.</p>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Função para alternar a visibilidade da resposta
function toggleAnswer(index) {
    const answerSection = document.getElementById(`answerSection${index}`);
    if (answerSection) {
        answerSection.style.display = answerSection.style.display === 'none' ? 'block' : 'none';
    }
}

// Função para carregar os detalhes de geração
function loadGenerationDetails(question, index) {
    if (!question.question_prompt_id) return;

    // Carregar prompts
    fetch(`/api/prompt/${question.question_prompt_id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById(`questionPrompt${index}`).textContent = data.prompt_text;
        })
        .catch(error => console.error('Erro ao carregar prompt da pergunta:', error));

    fetch(`/api/prompt/${question.answer_prompt_id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById(`answerPrompt${index}`).textContent = data.prompt_text;
        })
        .catch(error => console.error('Erro ao carregar prompt da resposta:', error));

    fetch(`/api/prompt/${question.distractors_prompt_id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById(`distractorsPrompt${index}`).textContent = data.prompt_text;
        })
        .catch(error => console.error('Erro ao carregar prompt dos distratores:', error));

    // Carregar chunks
    fetch(`/api/chunk/${question.question_chunk_id}`)
        .then(response => response.json())
        .then(data => {
            const chunksElement = document.getElementById(`questionChunks${index}`);
            if (chunksElement) {
                try {
                    const chunks = JSON.parse(data.content);
                    chunksElement.textContent = JSON.stringify(chunks, null, 2);
                } catch (e) {
                    chunksElement.textContent = data.content;
                }
            }
        })
        .catch(error => console.error('Erro ao carregar chunks da pergunta:', error));

    fetch(`/api/chunk/${question.answer_chunk_id}`)
        .then(response => response.json())
        .then(data => {
            const chunksElement = document.getElementById(`answerChunks${index}`);
            if (chunksElement) {
                try {
                    const chunks = JSON.parse(data.content);
                    chunksElement.textContent = JSON.stringify(chunks, null, 2);
                } catch (e) {
                    chunksElement.textContent = data.content;
                }
            }
        })
        .catch(error => console.error('Erro ao carregar chunks da resposta:', error));

    fetch(`/api/chunk/${question.distractors_chunk_id}`)
        .then(response => response.json())
        .then(data => {
            const chunksElement = document.getElementById(`distractorsChunks${index}`);
            if (chunksElement) {
                try {
                    const chunks = JSON.parse(data.content);
                    chunksElement.textContent = JSON.stringify(chunks, null, 2);
                } catch (e) {
                    chunksElement.textContent = data.content;
                }
            }
        })
        .catch(error => console.error('Erro ao carregar chunks dos distratores:', error));
}

// Atualizar a função toggleQuestionDetails
function toggleQuestionDetails(index) {
    console.log('Tentando alternar detalhes para questão:', index);
    
    const detailsElement = document.getElementById(`questionDetails${index}`);
    if (!detailsElement) {
        console.error('Elemento de detalhes não encontrado:', `questionDetails${index}`);
        return;
    }
    
    const questionCard = detailsElement.closest('.question-card');
    if (!questionCard) {
        console.error('Card da questão não encontrado');
        return;
    }
    
    const button = questionCard.querySelector('.question-header .mdc-button--icon');
    if (!button) {
        console.error('Botão não encontrado no card');
        return;
    }
    
    const icon = button.querySelector('i');
    if (!icon) {
        console.error('Ícone não encontrado no botão');
        return;
    }
    
    // Alternar visibilidade
    if (detailsElement.style.display === 'none') {
        detailsElement.style.display = 'block';
        icon.textContent = 'remove';
        console.log('Detalhes exibidos para questão:', index);
        
        // Carregar detalhes quando exibir
        const question = window.generatedQuestions[index];
        if (question) {
            loadGenerationDetails(question, index);
        }
    } else {
        detailsElement.style.display = 'none';
        icon.textContent = 'add';
        console.log('Detalhes ocultados para questão:', index);
    }
}

// Função para atualizar o estado do progresso
function updateProgress(step, message) {
    const progressMessage = document.getElementById('progressMessage');
    const progressSteps = document.getElementById('progressSteps').getElementsByClassName('progress-step');
    
    if (progressMessage && progressSteps) {
        progressMessage.textContent = message;
        
        // Atualizar ícones dos passos
        for (let i = 0; i < progressSteps.length; i++) {
            const icon = progressSteps[i].querySelector('.material-icons');
            if (i < step) {
                icon.textContent = 'check_circle';
                icon.style.color = '#4CAF50';
            } else if (i === step) {
                icon.textContent = 'autorenew';
                icon.style.color = '#2196F3';
                icon.classList.add('rotating');
            } else {
                icon.textContent = 'pending';
                icon.style.color = '';
                icon.classList.remove('rotating');
            }
        }
    }
}

// Função segura para fechar o diálogo
function safeCloseDialog() {
    if (window.progressDialog && window.progressDialog.isOpen) {
        try {
            window.progressDialog.close();
            console.log('Diálogo fechado com sucesso');
        } catch (error) {
            console.error('Erro ao fechar diálogo:', error);
        }
    }
}

// Adicionar estilo para o ícone rotativo
const style = document.createElement('style');
style.textContent = `
    .rotating {
        animation: rotate 2s linear infinite;
    }
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Função para excluir uma questão
async function deleteQuestion(index) {
    if (!window.generatedQuestions || !window.generatedQuestions[index]) {
        console.error('Questão não encontrada');
        return;
    }

    const question = window.generatedQuestions[index];
    const questionElement = document.getElementById(`question-${index}`);
    
    if (!questionElement) {
        console.error('Elemento da questão não encontrado');
        return;
    }

    // Confirmar exclusão
    if (!confirm('Tem certeza que deseja excluir esta questão?')) {
        return;
    }

    try {
        // Se a questão tem ID, excluir do banco de dados
        if (question.id) {
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
            
            const response = await fetch(`/api/question/${question.id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (!response.ok) {
                throw new Error('Falha ao excluir questão do banco de dados');
            }
        }

        // Remover questão do array
        window.generatedQuestions.splice(index, 1);
        
        // Remover elemento da interface
        questionElement.remove();
        
        // Atualizar índices das questões restantes
        const remainingQuestions = document.querySelectorAll('.question-card');
        remainingQuestions.forEach((element, idx) => {
            const titleElement = element.querySelector('.mdc-typography--headline6');
            if (titleElement) {
                titleElement.textContent = `Questão ${idx + 1}`;
            }
        });

        // Se não houver mais questões, ocultar a seção de resultados
        if (window.generatedQuestions.length === 0) {
            document.getElementById('resultsSection').style.display = 'none';
        }

    } catch (error) {
        console.error('Erro ao excluir questão:', error);
        alert('Erro ao excluir questão: ' + error.message);
    }
}

function displayQuestions(questions) {
    const container = document.getElementById('questionsContainer');
    const debugContainer = document.getElementById('debugContainer');
    container.innerHTML = '';
    debugContainer.innerHTML = '';
    
    questions.forEach((question, index) => {
        // Criar elemento para a questão
        const questionElement = document.createElement('div');
        questionElement.className = 'mdc-card';
        questionElement.style.marginBottom = '20px';
        questionElement.style.padding = '20px';
        
        // Adicionar pergunta
        const questionText = document.createElement('h4');
        questionText.textContent = `${index + 1}. ${question.question || 'Pergunta não disponível'}`;
        questionElement.appendChild(questionText);
        
        // Adicionar opções
        const optionsList = document.createElement('ul');
        if (question.options && question.options.length > 0) {
            question.options.forEach((option, i) => {
                const li = document.createElement('li');
                li.textContent = `${String.fromCharCode(65 + i)}. ${option || 'Opção não disponível'}`;
                optionsList.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'Opções não disponíveis';
            optionsList.appendChild(li);
        }
        questionElement.appendChild(optionsList);
        
        // Adicionar resposta correta
        const correctAnswer = document.createElement('p');
        correctAnswer.textContent = `Resposta Correta: ${question.correct_answer || 'Não disponível'}`;
        correctAnswer.style.fontWeight = 'bold';
        questionElement.appendChild(correctAnswer);
        
        // Adicionar explicação
        const explanation = document.createElement('p');
        explanation.textContent = `Explicação: ${question.explanation || 'Não disponível'}`;
        explanation.style.marginTop = '10px';
        questionElement.appendChild(explanation);
        
        container.appendChild(questionElement);
        
        // Adicionar informações de debug
        if (question.debug_info) {
            const debugElement = document.createElement('div');
            debugElement.className = 'mdc-card';
            debugElement.style.marginBottom = '20px';
            debugElement.style.padding = '20px';
            debugElement.style.backgroundColor = '#f5f5f5';
            
            const debugTitle = document.createElement('h4');
            debugTitle.textContent = `Debug - Questão ${index + 1}`;
            debugElement.appendChild(debugTitle);
            
            // Prompt do conteúdo
            const contentPrompt = document.createElement('div');
            contentPrompt.innerHTML = `<strong>Prompt do Conteúdo:</strong><pre>${question.debug_info.content_prompt || 'Não disponível'}</pre>`;
            debugElement.appendChild(contentPrompt);
            
            // Prompt das questões
            const questionsPrompt = document.createElement('div');
            questionsPrompt.innerHTML = `<strong>Prompt das Questões:</strong><pre>${question.debug_info.questions_prompt || 'Não disponível'}</pre>`;
            debugElement.appendChild(questionsPrompt);
            
            // Resposta bruta
            const rawResponse = document.createElement('div');
            rawResponse.innerHTML = `<strong>Resposta Bruta:</strong><pre>${question.debug_info.raw_response || 'Não disponível'}</pre>`;
            debugElement.appendChild(rawResponse);
            
            debugContainer.appendChild(debugElement);
        }
    });
}

function showGeneratedQuestions(questions) {
    const container = document.getElementById('generated-questions');
    container.innerHTML = '';
    
    questions.forEach((question, index) => {
        const card = document.createElement('div');
        card.className = 'mdc-card';
        card.style = 'margin-bottom: 16px; padding: 16px;';
        
        // Log para debug
        console.log('Questão:', question);
        
        let html = `
            <div class="mdc-card__primary">
                <h2 class="mdc-typography--headline6">Questão ${index + 1}</h2>
            </div>
            <div class="mdc-card__content">
                <p class="mdc-typography--body1">${question.question}</p>
                
                <div class="options-area" style="margin: 16px 0;">
                    ${question.options.map((opt, idx) => `
                        <div class="option" style="margin-bottom: 8px;">
                            <span class="mdc-typography--body2">
                                ${String.fromCharCode(65 + idx)}. ${opt}
                                ${idx === question.correct_answer ? ' ✓' : ''}
                            </span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="explanation" style="margin-top: 16px;">
                    <h3 class="mdc-typography--subtitle1">Explicação:</h3>
                    <p class="mdc-typography--body2">${question.explanation}</p>
                </div>
                
                ${question.metadata ? `
                    <div class="metadata" style="margin-top: 16px;">
                        <h3 class="mdc-typography--subtitle1">Informações Adicionais:</h3>
                        ${question.metadata.pmbok_references ? `
                            <p class="mdc-typography--body2">
                                <strong>Referências PMBOK:</strong><br>
                                ${question.metadata.pmbok_references.join('<br>')}
                            </p>
                        ` : ''}
                        ${question.metadata.practical_examples ? `
                            <p class="mdc-typography--body2">
                                <strong>Exemplos Práticos:</strong><br>
                                ${question.metadata.practical_examples.join('<br>')}
                            </p>
                        ` : ''}
                        ${question.metadata.warnings ? `
                            <div class="warnings" style="margin-top: 8px; padding: 8px; background-color: #fff3e0; border-radius: 4px;">
                                <p class="mdc-typography--body2" style="color: #e65100; margin: 0;">
                                    <i class="material-icons" style="font-size: 16px; vertical-align: text-bottom;">warning</i>
                                    Avisos:
                                </p>
                                <ul style="margin: 4px 0 0 0; padding-left: 24px;">
                                    ${question.metadata.warnings.map(warning => `
                                        <li class="mdc-typography--body2" style="color: #e65100;">${warning}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        `;
        
        card.innerHTML = html;
        container.appendChild(card);
    });
}

async function generateQuestions() {
    const topic = document.getElementById('topic').value;
    const numQuestions = document.getElementById('num-questions').value;
    
    if (!topic) {
        alert('Por favor, selecione um tópico.');
        return;
    }
    
    if (!numQuestions || numQuestions < 1 || numQuestions > 20) {
        alert('O número de questões deve estar entre 1 e 20.');
        return;
    }
    
    // Verificar se o diálogo está disponível
    if (!window.progressDialog) {
        console.error('Diálogo não inicializado');
        try {
            window.progressDialog = new mdc.dialog.MDCDialog(document.getElementById('progressDialog'));
            console.log('Diálogo inicializado no submit');
        } catch (error) {
            console.error('Erro ao inicializar diálogo no submit:', error);
            alert('Erro interno: não foi possível mostrar o diálogo de progresso');
            return;
        }
    }
    
    try {
        window.progressDialog.open();
        updateProgress(0, 'Validando parâmetros...');
        console.log('Diálogo aberto com sucesso');
    } catch (error) {
        console.error('Erro ao abrir diálogo:', error);
        alert('Erro interno: não foi possível mostrar o diálogo de progresso');
        return;
    }
    
    // Enviar requisição para gerar questões
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (!csrfMeta) {
        alert('Erro interno: CSRF token não encontrado no template.');
        safeCloseDialog();
        return;
    }
    
    updateProgress(1, 'Gerando questões...');
    
    const csrfToken = csrfMeta.getAttribute('content');
    try {
        const response = await fetch('/api/generate-questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                topic: topic,
                num_questions: parseInt(numQuestions)
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Erro ao gerar questões');
        }
        
        if (!result.success) {
            throw new Error(result.error || 'Erro ao gerar questões');
        }
        
        // Log para debug
        console.log('Questões geradas:', result.questions);
        
        updateProgress(100, 'Questões geradas com sucesso!');
        setTimeout(() => {
            safeCloseDialog();
            showGeneratedQuestions(result.questions);
        }, 1000);
        
    } catch (error) {
        console.error('Erro ao gerar questões:', error);
        updateProgress(0, `Erro: ${error.message}`);
        setTimeout(safeCloseDialog, 2000);
    }
}
</script>

<style>
.question-card {
    border: 1px solid rgba(0, 0, 0, 0.12);
    border-radius: 4px;
}

.question-header {
    margin-bottom: 1rem;
}

.question-body {
    margin-bottom: 1rem;
}

.mdc-chip-set {
    margin-top: 0.5rem;
}

.mdc-chip {
    margin-right: 0.5rem;
}

.answer-section {
    border-top: 1px solid rgba(0, 0, 0, 0.12);
    padding-top: 1rem;
    margin-top: 1rem;
}

.config-field-container {
    background-color: #f5f5f5;
    padding: 16px;
    border-radius: 4px;
    height: 100%;
}

.mdc-text-field {
    background-color: white !important;
}

.mdc-select {
    background-color: white !important;
}

.mdc-button--raised {
    background-color: #6200ee !important;
}

.mdc-typography--subtitle1 {
    font-weight: 500;
}

.mdc-typography--caption {
    color: rgba(0, 0, 0, 0.6);
}
</style>
{% endblock %} 